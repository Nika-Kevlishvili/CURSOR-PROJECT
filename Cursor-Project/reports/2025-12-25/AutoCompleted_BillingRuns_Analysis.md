# Billing Run-рЃћрЃЉрЃўрЃА рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃў

**рЃЌрЃљрЃарЃўрЃдрЃў:** 2025-12-25  
**рЃњрЃљрЃарЃћрЃЏрЃЮ:** Test (10.236.20.24:5432/phoenix)  
**рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** Billing run-рЃћрЃЉрЃў рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ, рЃЏрЃўрЃџрЃўрЃгрЃљрЃЏрЃћрЃЉрЃўрЃА рЃЊрЃљрЃерЃЮрЃарЃћрЃЉрЃўрЃЌ  
**рЃцрЃЮрЃЎрЃБрЃАрЃў:** CANCELLED-рЃЊрЃљрЃю COMPLETED-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃАрЃБрЃџрЃў billing run-рЃћрЃЉрЃў

## ­ЪћЇ рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃўрЃА рЃљрЃдрЃгрЃћрЃарЃљ

Test рЃњрЃљрЃарЃћрЃЏрЃЮрЃќрЃћ billing run-рЃћрЃЉрЃў рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў, рЃ«рЃерЃўрЃарЃљрЃЊ рЃЏрЃўрЃџрЃўрЃгрЃљрЃЏрЃћрЃЉрЃўрЃА рЃЊрЃљрЃерЃЮрЃарЃћрЃЉрЃўрЃЌ. рЃћрЃА рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћрЃЉрЃА, рЃарЃЮрЃЏ рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ billing run рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃЊрЃљрЃЏрЃБрЃерЃљрЃЋрЃЊрЃљ рЃЊрЃљ рЃАрЃбрЃљрЃбрЃБрЃАрЃў рЃерЃћрЃўрЃфрЃЋрЃљрЃџрЃљ.

**Рџа№ИЈ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў рЃерЃћрЃюрЃўрЃерЃЋрЃюрЃљ:** рЃЉрЃљрЃќрЃљрЃерЃў рЃљрЃа рЃљрЃарЃАрЃћрЃЉрЃЮрЃЉрЃА billing run-рЃћрЃЉрЃўрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃўрЃАрЃбрЃЮрЃарЃўрЃўрЃА рЃфрЃ«рЃарЃўрЃџрЃў (`billing_status_change_hist` рЃљрЃю рЃЏрЃАрЃњрЃљрЃЋрЃАрЃў). рЃљрЃЏрЃўрЃбрЃЮрЃЏ, **рЃерЃћрЃБрЃФрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ рЃќрЃБрЃАрЃбрЃљрЃЊ рЃЊрЃљрЃЊрЃњрЃўрЃюрЃЊрЃћрЃА, рЃарЃЮрЃЏрЃћрЃџ billing run-рЃћрЃЉрЃА рЃ░рЃЦрЃЮрЃюрЃЊрЃљрЃЌ CANCELLED рЃгрЃўрЃюрЃљ рЃАрЃбрЃљрЃбрЃБрЃАрЃљрЃЊ**. 

рЃЌрЃБрЃЏрЃфрЃљ, рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃњрЃљрЃЋрЃљрЃљрЃюрЃљрЃџрЃўрЃќрЃЮрЃЌ рЃерЃћрЃЏрЃЊрЃћрЃњрЃў рЃўрЃюрЃЊрЃўрЃЎрЃљрЃбрЃЮрЃарЃћрЃЉрЃў:
- рЃЊрЃўрЃЊрЃў рЃЊрЃарЃЮрЃўрЃА рЃўрЃюрЃбрЃћрЃарЃЋрЃљрЃџрЃў create_date-рЃАрЃљ рЃЊрЃљ modify_date-рЃА рЃерЃЮрЃарЃўрЃА (рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћрЃЉрЃЊрЃћрЃА, рЃарЃЮрЃЏ рЃўрЃДрЃЮ CANCELLED рЃЊрЃљ рЃерЃћрЃЏрЃЊрЃћрЃњ resume-рЃЊрЃљ)
- Process stage-рЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃў (рЃЌрЃБ process stage рЃљрЃарЃўрЃА DRAFT, DRAFT_DOCUMENT рЃљрЃю ACCOUNTING, рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ resume-рЃЊрЃљ)

## ­ЪЊі рЃюрЃљрЃърЃЮрЃЋрЃюрЃў рЃЕрЃљрЃюрЃљрЃгрЃћрЃарЃћрЃЉрЃў

рЃЉрЃљрЃќрЃљрЃерЃў рЃюрЃљрЃърЃЮрЃЋрЃюрЃўрЃљ рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ billing run, рЃарЃЮрЃЏрЃџрЃћрЃЉрЃўрЃф COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃюрЃћрЃю. рЃЦрЃЋрЃћрЃЏрЃЮрЃЌ рЃЏрЃЮрЃфрЃћрЃЏрЃБрЃџрЃўрЃљ рЃљрЃюрЃљрЃџрЃўрЃќрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃцрЃЮрЃЎрЃБрЃАрЃўрЃарЃћрЃЉрЃБрЃџрЃўрЃљ CANCELLED-рЃЊрЃљрЃю COMPLETED-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃўрЃА рЃерЃћрЃАрЃљрЃФрЃџрЃЮ рЃерЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃћрЃЉрЃќрЃћ:

### рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃў рЃерЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃћрЃЉрЃў:

1. **Billing Run ID 1647** - рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED-рЃерЃў **14.78 рЃЏрЃўрЃџрЃўрЃгрЃљрЃЏрЃерЃў** рЃерЃћрЃЦрЃЏрЃюрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ
   - Billing Number: BILLING202512230014
   - Create Date: 2025-12-23 13:55:15.351
   - Modify Date: 2025-12-23 13:55:15.366
   - Type: STANDARD_BILLING
   - Process Stage: DRAFT

2. **2025-12-22, 11:54:xx** - **19 billing run** рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED-рЃерЃў:
   - IDs: 1601-1619
   - рЃДрЃЋрЃћрЃџрЃљ STANDARD_BILLING рЃбрЃўрЃърЃўрЃАрЃљрЃљ
   - рЃДрЃЋрЃћрЃџрЃљ DRAFT process stage-рЃќрЃћрЃљ
   - Modify dates: 11:53:13 - 11:54:39 (рЃЊрЃљрЃљрЃ«рЃџрЃЮрЃћрЃЉрЃўрЃЌ 1 рЃгрЃБрЃЌрЃўрЃА рЃњрЃљрЃюрЃЏрЃљрЃЋрЃџрЃЮрЃЉрЃљрЃерЃў)

## ­Ъћј рЃЏрЃўрЃќрЃћрЃќрЃўрЃА рЃўрЃЊрЃћрЃюрЃбрЃўрЃцрЃўрЃфрЃўрЃарЃћрЃЉрЃљ

### 1. рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃў Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў

**рЃцрЃљрЃўрЃџрЃў:** `BillingRunStartGenerationService.java` (рЃ«рЃљрЃќрЃћрЃЉрЃў 108-114)

```java
try {
    List<RunStage> runStages = ListUtils.emptyIfNull(billingRun.getRunStages());
    if (CollectionUtils.isNotEmpty(runStages)) {
        if (runStages.contains(RunStage.AUTOMATICALLY_ACCOUNTING)) {
            getNextJobInChain().execute(billingRunId, false, false);  // Рџа№ИЈ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃгрЃДрЃћрЃЉрЃА accounting-рЃА
        }
    }
}
```

**рЃЏрЃўрЃќрЃћрЃќрЃў:** рЃарЃЮрЃЊрЃћрЃАрЃљрЃф billing run-рЃА рЃљрЃЦрЃЋрЃА `AUTOMATICALLY_ACCOUNTING` run stage, generation-рЃўрЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ рЃўрЃњрЃў **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃўрЃгрЃДрЃћрЃЉрЃА accounting рЃърЃарЃЮрЃфрЃћрЃАрЃА, рЃарЃљрЃф рЃерЃћрЃЏрЃЊрЃћрЃњ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃљрЃДрЃћрЃюрЃћрЃЉрЃА COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў.

### 2. Accounting-рЃўрЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃљ рЃЊрЃљ COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃљ

**рЃцрЃљрЃўрЃџрЃў:** `BillingRunStartAccountingService.java` (рЃ«рЃљрЃќрЃћрЃЉрЃў 108-114)

```java
new Thread(() -> {
    try {
        billingRunStartAccountingInvokeService.invoke(billingRun);
        
        log.debug("Billing run status changed to 'COMPLETED'");
        billingRun.setStatus(BillingStatus.COMPLETED);  // Рџа№ИЈ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃфрЃЋрЃџрЃћрЃЉрЃљ COMPLETED-рЃќрЃћ
        billingRunRepository.save(billingRun);
        // ...
    }
}).start();
```

**рЃЏрЃўрЃќрЃћрЃќрЃў:** Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, billing run-рЃўрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃў **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃўрЃфрЃЋрЃџрЃћрЃЉрЃљ COMPLETED-рЃќрЃћ.

### 3. Scheduler-рЃўрЃА рЃарЃЮрЃџрЃўрЃА рЃњрЃљрЃЋрЃџрЃћрЃюрЃљ

**рЃцрЃљрЃўрЃџрЃў:** `BillingRunStandardPreparationStateScheduler.java` (рЃ«рЃљрЃќрЃћрЃЉрЃў 34-40)

```java
@Scheduled(fixedDelay = 15, timeUnit = TimeUnit.SECONDS)
public void stateListener() {
    log.debug(LoggerUtils.prettyLogging("Billing run state listener iteration started %s".formatted(LocalDate.now())));
    ExecutorService processExecutor = Executors.newSingleThreadExecutor();
    processExecutor.submit(stateHandler::finishStandardBillingProcessing);
    processExecutor.submit(stateHandler::startStandardBillingProcessing);
    processExecutor.shutdown();
}
```

**рЃЏрЃўрЃќрЃћрЃќрЃў:** Scheduler рЃДрЃЮрЃЋрЃћрЃџ 15 рЃгрЃљрЃЏрЃерЃў рЃћрЃарЃЌрЃ«рЃћрЃџ рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА рЃЊрЃљ рЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃА billing run-рЃћрЃЉрЃА. рЃЌрЃБ рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ billing run рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃљрЃарЃўрЃА рЃЏрЃќрЃљрЃЊ рЃЊрЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА, рЃўрЃАрЃўрЃюрЃў рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃўрЃгрЃДрЃћрЃЉрЃћрЃю рЃърЃарЃЮрЃфрЃћрЃАрЃА.

### 4. Generation-рЃўрЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃљ рЃЊрЃљ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃў Accounting-рЃўрЃА рЃњрЃљрЃерЃЋрЃћрЃЉрЃљ

**рЃцрЃљрЃўрЃџрЃў:** `BillingRunStandardInvoiceGenerationService.java` (рЃ«рЃљрЃќрЃћрЃЉрЃў 140-153)

```java
if (!applicationModelContainsInterimAdvancePayment) {
    billingRun.setStatus(BillingStatus.DRAFT);
    billingRunRepository.save(billingRun);
    
    billingRunRepository.finalizeDataPreparation(billingRun.getId());
    
    invoiceService.generateExcel(billingRunId, InvoiceStatus.DRAFT);
    
    if (ListUtils.emptyIfNull(billingRun.getRunStages()).contains(RunStage.GENERATE_AND_SIGN)) {
        billingRunStartGenerationService.execute(billingRunId, false, false);  // Рџа№ИЈ рЃўрЃгрЃДрЃћрЃЉрЃА generation-рЃА
    }
}
```

**рЃЏрЃўрЃќрЃћрЃќрЃў:** Generation-рЃўрЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃЌрЃБ billing run-рЃА рЃљрЃЦрЃЋрЃА `GENERATE_AND_SIGN` run stage, рЃўрЃњрЃў рЃўрЃгрЃДрЃћрЃЉрЃА generation рЃърЃарЃЮрЃфрЃћрЃАрЃА, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃерЃћрЃЏрЃЊрЃћрЃњ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃгрЃДрЃћрЃЉрЃА accounting-рЃА (рЃЌрЃБ рЃљрЃЦрЃЋрЃА `AUTOMATICALLY_ACCOUNTING`).

## ­ЪћЇ CANCELLED-рЃЊрЃљрЃю COMPLETED-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃў

### Resume() рЃЏрЃћрЃЌрЃЮрЃЊрЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃў

**рЃцрЃљрЃўрЃџрЃў:** `BillingRunService.java` (рЃ«рЃљрЃќрЃћрЃЉрЃў 2549-2584)

```java
@Transactional
public void resume(Long billingRunId, boolean mustCheckPermission) {
    BillingRun billingRun = billingRunRepository.findById(billingRunId)
        .orElseThrow(...);
    
    BillingRunProcessStage processStage = billingRun.getProcessStage();
    if (Objects.isNull(processStage)) {
        throw new IllegalArgumentsProvidedException("Cannot resume process, unknown process stage");
    }

    switch (processStage) {
        case DRAFT -> {
            billingRun.setStatus(BillingStatus.IN_PROGRESS_DRAFT);
            // ...
        }
        case DRAFT_DOCUMENT -> {
            billingRun.setStatus(BillingStatus.IN_PROGRESS_GENERATION);
            // ...
        }
        case ACCOUNTING -> {
            billingRun.setStatus(BillingStatus.IN_PROGRESS_ACCOUNTING);
            // ...
        }
    }
}
```

**Рџа№ИЈ рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃў рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃў **рЃљрЃа рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА** billing run-рЃўрЃА рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћ рЃАрЃбрЃљрЃбрЃБрЃАрЃА (CANCELLED, PAUSED, рЃЊрЃљ рЃљ.рЃе.). рЃўрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ `processStage`-рЃА рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА.

**рЃћрЃА рЃюрЃўрЃерЃюрЃљрЃЋрЃА:**
- рЃЌрЃБ billing run-рЃА рЃљрЃЦрЃЋрЃА **CANCELLED** рЃАрЃбрЃљрЃбрЃБрЃАрЃў, рЃЏрЃљрЃњрЃарЃљрЃЏ `processStage` рЃљрЃарЃўрЃА DRAFT, DRAFT_DOCUMENT рЃљрЃю ACCOUNTING
- `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃў **рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃњрЃљрЃћрЃерЃЋрЃљрЃА** рЃЊрЃљ billing run-рЃў рЃњрЃљрЃЊрЃљрЃЋрЃљ IN_PROGRESS рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў
- рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃЌрЃБ billing run-рЃА рЃљрЃЦрЃЋрЃА `AUTOMATICALLY_ACCOUNTING` run stage, рЃўрЃњрЃў рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃљрЃЊрЃљрЃЋрЃљ COMPLETED-рЃќрЃћ

### Cancel() рЃЏрЃћрЃЌрЃЮрЃЊрЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃў

**рЃцрЃљрЃўрЃџрЃў:** `BillingRunService.java` (рЃ«рЃљрЃќрЃћрЃЉрЃў 2475-2513)

```java
public void cancel(Long billingRunId, boolean mustCheckPermission) {
    // ...
    List<BillingStatus> availableStatusesForTermination = List.of(
        BillingStatus.INITIAL,
        BillingStatus.IN_PROGRESS_DRAFT,
        BillingStatus.DRAFT,
        BillingStatus.IN_PROGRESS_GENERATION,
        BillingStatus.GENERATED,
        BillingStatus.PAUSED
    );
    
    if (!availableStatusesForTermination.contains(billingRun.getStatus())) {
        throw new IllegalArgumentsProvidedException("Termination available only for followed statuses: [...]");
    }
    
    // ...
    billingRun.setStatus(BillingStatus.CANCELLED);
    billingRunRepository.save(billingRun);
}
```

**рЃЊрЃљрЃАрЃЎрЃЋрЃюрЃљ:** Cancel() рЃЏрЃћрЃЌрЃЮрЃЊрЃў рЃљрЃДрЃћрЃюрЃћрЃЉрЃА CANCELLED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў, рЃЏрЃљрЃњрЃарЃљрЃЏ **рЃљрЃа рЃўрЃфрЃЋрЃџрЃўрЃА** `processStage`-рЃА. рЃћрЃА рЃюрЃўрЃерЃюрЃљрЃЋрЃА, рЃарЃЮрЃЏ `processStage` рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃЊрЃљрЃарЃЕрЃћрЃА DRAFT, DRAFT_DOCUMENT рЃљрЃю ACCOUNTING.

### рЃерЃћрЃАрЃљрЃФрЃџрЃЮ рЃАрЃфрЃћрЃюрЃљрЃарЃў: CANCELLED Рєњ COMPLETED

1. Billing run рЃўрЃЦрЃЏрЃюрЃћрЃЉрЃљ рЃЊрЃљ `processStage` рЃљрЃарЃўрЃА DRAFT
2. Billing run рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА GENERATED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў
3. Billing run-рЃА рЃљрЃЦрЃЋрЃА `AUTOMATICALLY_ACCOUNTING` run stage
4. Billing run рЃўрЃгрЃДрЃћрЃЉрЃА accounting рЃърЃарЃЮрЃфрЃћрЃАрЃА
5. **рЃарЃљрЃўрЃЏрЃћ рЃЏрЃўрЃќрЃћрЃќрЃўрЃЌ** billing run-рЃў рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА CANCELLED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў (рЃЏрЃљрЃњ. manual cancel)
6. `processStage` рЃЎрЃЋрЃџрЃљрЃЋ рЃЊрЃљрЃарЃЕрЃћрЃЉрЃљ ACCOUNTING (рЃљрЃю DRAFT_DOCUMENT)
7. `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃў рЃњрЃљрЃћрЃерЃЋрЃћрЃЉрЃљ (рЃЏрЃљрЃюрЃБрЃљрЃџрЃБрЃарЃљрЃЊ рЃљрЃю scheduler-рЃўрЃА рЃЏрЃўрЃћрЃа)
8. `resume()` рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ `processStage`-рЃА, рЃљрЃарЃљ рЃАрЃбрЃљрЃбрЃБрЃАрЃА
9. Billing run рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА IN_PROGRESS_ACCOUNTING рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў
10. Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ
11. Billing run **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў

## ­Ъј» рЃарЃљрЃбрЃЮрЃЏ рЃ«рЃЊрЃћрЃЉрЃљ рЃћрЃА?

### рЃАрЃфрЃћрЃюрЃљрЃарЃў 1: AUTOMATICALLY_ACCOUNTING Run Stage-рЃўрЃЌ

1. Billing run рЃўрЃЦрЃЏрЃюрЃћрЃЉрЃљ `AUTOMATICALLY_ACCOUNTING` run stage-рЃўрЃЌ
2. Generation рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ рЃЊрЃљ рЃАрЃбрЃљрЃбрЃБрЃАрЃў рЃўрЃфрЃЋрЃџрЃћрЃЉрЃљ GENERATED-рЃќрЃћ
3. **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃўрЃгрЃДрЃћрЃЉрЃљ accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў (BillingRunStartGenerationService, рЃ«рЃљрЃќрЃў 112)
4. Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ
5. **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃАрЃбрЃљрЃбрЃБрЃАрЃў рЃўрЃфрЃЋрЃџрЃћрЃЉрЃљ COMPLETED-рЃќрЃћ (BillingRunStartAccountingService, рЃ«рЃљрЃќрЃў 113)

### рЃАрЃфрЃћрЃюрЃљрЃарЃў 2: Resume() + BillingRunStartAccountingScheduler (AUTOMATICALLY_ACCOUNTING-рЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ)

**Рџа№ИЈ рЃћрЃА рЃљрЃарЃўрЃА рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃЏрЃўрЃќрЃћрЃќрЃў, рЃарЃљрЃбрЃЮрЃЏ billing run-рЃћрЃЉрЃў рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED-рЃерЃў AUTOMATICALLY_ACCOUNTING-рЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ!**

1. Billing run-рЃА рЃљрЃЦрЃЋрЃА **GENERATED** рЃАрЃбрЃљрЃбрЃБрЃАрЃў рЃЊрЃљ **ACCOUNTING** `processStage` (рЃЏрЃљрЃњ. рЃгрЃўрЃюрЃљ accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃЊрЃљрЃўрЃгрЃДрЃЮ, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃерЃћрЃгрЃДрЃЊрЃљ)
2. `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃў рЃњрЃљрЃћрЃерЃЋрЃћрЃЉрЃљ (рЃЏрЃљрЃюрЃБрЃљрЃџрЃБрЃарЃљрЃЊ рЃљрЃю scheduler-рЃўрЃА рЃЏрЃўрЃћрЃа)
3. `resume()` рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ `processStage`-рЃА, рЃљрЃарЃљ рЃАрЃбрЃљрЃбрЃБрЃАрЃА
4. рЃЌрЃБ `processStage` рЃљрЃарЃўрЃА ACCOUNTING, `resume()` рЃљрЃДрЃћрЃюрЃћрЃЉрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃА **IN_PROGRESS_ACCOUNTING**-рЃќрЃћ
5. **BillingRunStartAccountingScheduler** (PostConstruct-рЃерЃў) рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА IN_PROGRESS_ACCOUNTING рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА billing run-рЃћрЃЉрЃА
6. Scheduler **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃўрЃгрЃДрЃћрЃЉрЃА accounting рЃърЃарЃЮрЃфрЃћрЃАрЃА `accountingService.execute(billingRunId, true, false)` - рЃАрЃљрЃЊрЃљрЃф `isResumeProcess = true`
7. Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ
8. Billing run **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў

**рЃЎрЃЮрЃЊрЃў:**
- `BillingRunService.java:2579-2581` - resume() рЃљрЃДрЃћрЃюрЃћрЃЉрЃА IN_PROGRESS_ACCOUNTING-рЃќрЃћ
- `BillingRunStartAccountingScheduler.java:35` - рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА IN_PROGRESS_ACCOUNTING рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА billing run-рЃћрЃЉрЃА
- `BillingRunStartAccountingScheduler.java:54` - рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃгрЃДрЃћрЃЉрЃА accounting-рЃА `isResumeProcess = true`-рЃўрЃЌ
- `BillingRunStartAccountingService.java:88-92` - рЃЌрЃБ `isResumeProcess = true`, рЃљрЃа рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА GENERATED рЃАрЃбрЃљрЃбрЃБрЃАрЃА

### рЃАрЃфрЃћрЃюрЃљрЃарЃў 3: Scheduler-рЃўрЃА рЃњрЃљрЃЋрЃџрЃћрЃюрЃљ (AUTOMATICALLY_ACCOUNTING-рЃўрЃЌ)

1. рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ billing run рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃљрЃарЃўрЃА DRAFT рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў
2. Scheduler (рЃДрЃЮрЃЋрЃћрЃџ 15 рЃгрЃљрЃЏрЃерЃў) рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА рЃЊрЃљ рЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃА рЃЏрЃљрЃЌ
3. рЃЌрЃБ рЃДрЃЋрЃћрЃџрЃљрЃА рЃљрЃЦрЃЋрЃА `AUTOMATICALLY_ACCOUNTING`, рЃўрЃАрЃўрЃюрЃў рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃўрЃгрЃДрЃћрЃЉрЃћрЃю accounting-рЃА
4. Accounting-рЃўрЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃДрЃЋрЃћрЃџрЃљ рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED-рЃерЃў

## ­ЪћЇ Billing Run ID 1620 - рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃљрЃюрЃљрЃџрЃўрЃќрЃў

### рЃарЃљрЃбрЃЮрЃЏ рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED-рЃерЃў AUTOMATICALLY_ACCOUNTING-рЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ?

**Billing Run ID 1620:**
- Billing Number: BILLING202512220055
- Type: STANDARD_BILLING
- Process Stage: DRAFT (COMPLETED-рЃерЃў рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃўрЃА рЃЊрЃарЃЮрЃА)
- Create Date: 2025-12-22 11:02:08.136
- Modify Date: 2025-12-22 11:02:28.387
- Seconds Between: 20.25 рЃгрЃљрЃЏрЃў

**рЃерЃћрЃАрЃљрЃФрЃџрЃЮ рЃАрЃфрЃћрЃюрЃљрЃарЃў:**

1. Billing run рЃерЃћрЃўрЃЦрЃЏрЃюрЃљ рЃЊрЃљ рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ GENERATED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў
2. Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃЊрЃљрЃўрЃгрЃДрЃЮ (рЃЏрЃљрЃюрЃБрЃљрЃџрЃБрЃарЃљрЃЊ рЃљрЃю рЃАрЃ«рЃЋрЃљ рЃњрЃќрЃўрЃЌ) рЃЊрЃљ `processStage` рЃњрЃљрЃ«рЃЊрЃљ ACCOUNTING
3. **рЃарЃљрЃўрЃЏрЃћ рЃЏрЃўрЃќрЃћрЃќрЃўрЃЌ** accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃерЃћрЃгрЃДрЃЊрЃљ рЃљрЃю billing run-рЃў рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ DRAFT рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў, рЃЏрЃљрЃњрЃарЃљрЃЏ `processStage` рЃЊрЃљрЃарЃЕрЃљ ACCOUNTING (рЃљрЃю рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ DRAFT-рЃќрЃћ)
4. `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃў рЃњрЃљрЃћрЃерЃЋрЃћрЃЉрЃљ (рЃЏрЃљрЃюрЃБрЃљрЃџрЃБрЃарЃљрЃЊ рЃљрЃю scheduler-рЃўрЃА рЃЏрЃўрЃћрЃа)
5. `resume()` рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА `processStage`-рЃА:
   - рЃЌрЃБ `processStage` рЃљрЃарЃўрЃА ACCOUNTING Рєњ рЃљрЃДрЃћрЃюрЃћрЃЉрЃА IN_PROGRESS_ACCOUNTING-рЃќрЃћ
   - рЃЌрЃБ `processStage` рЃљрЃарЃўрЃА DRAFT Рєњ рЃљрЃДрЃћрЃюрЃћрЃЉрЃА IN_PROGRESS_DRAFT-рЃќрЃћ
6. **BillingRunStartAccountingScheduler** (PostConstruct-рЃерЃў) рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА IN_PROGRESS_ACCOUNTING рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА billing run-рЃћрЃЉрЃА
7. Scheduler **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃўрЃгрЃДрЃћрЃЉрЃА accounting рЃърЃарЃЮрЃфрЃћрЃАрЃА
8. Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ (20.25 рЃгрЃљрЃЏрЃерЃў)
9. Billing run **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў

**Рџа№ИЈ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў:** рЃћрЃА рЃ«рЃЊрЃћрЃЉрЃљ **AUTOMATICALLY_ACCOUNTING run stage-рЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ**, рЃарЃљрЃЊрЃњрЃљрЃю:
- `BillingRunStartAccountingScheduler` рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА IN_PROGRESS_ACCOUNTING рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА billing run-рЃћрЃЉрЃА
- Scheduler рЃўрЃгрЃДрЃћрЃЉрЃА accounting-рЃА `isResumeProcess = true`-рЃўрЃЌ
- `BillingRunStartAccountingService.execute()` рЃљрЃа рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА GENERATED рЃАрЃбрЃљрЃбрЃБрЃАрЃА, рЃЌрЃБ `isResumeProcess = true`

## ­ЪЊІ рЃЊрЃћрЃбрЃљрЃџрЃБрЃарЃў рЃљрЃюрЃљрЃџрЃўрЃќрЃў

### Billing Run-рЃћрЃЉрЃў, рЃарЃЮрЃЏрЃџрЃћрЃЉрЃўрЃф рЃАрЃгрЃарЃљрЃцрЃљрЃЊ рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃюрЃћрЃю COMPLETED-рЃерЃў:

| ID | Billing Number | Seconds Between | Type | Process Stage |
|----|----------------|-----------------|------|---------------|
| 1647 | BILLING202512230014 | 0.014 | STANDARD_BILLING | DRAFT |
| 1620 | BILLING202512220055 | 20.25 | STANDARD_BILLING | DRAFT |
| 1633 | BILLING202512220068 | 25.98 | MANUAL_CREDIT_OR_DEBIT_NOTE | ACCOUNTING |
| 1632 | BILLING202512220067 | 11.52 | MANUAL_CREDIT_OR_DEBIT_NOTE | ACCOUNTING |
| 1631 | BILLING202512220066 | 13.27 | MANUAL_INTERIM_AND_ADVANCE_PAYMENT | ACCOUNTING |

### рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃБрЃџрЃў Billing Run-рЃћрЃЉрЃў (2025-12-22, 11:54:xx):

**19 billing run** рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED-рЃерЃў рЃЊрЃљрЃљрЃ«рЃџрЃЮрЃћрЃЉрЃўрЃЌ 1 рЃгрЃБрЃЌрЃўрЃА рЃњрЃљрЃюрЃЏрЃљрЃЋрЃџрЃЮрЃЉрЃљрЃерЃў:
- IDs: 1601-1619
- рЃДрЃЋрЃћрЃџрЃљ STANDARD_BILLING рЃбрЃўрЃърЃўрЃАрЃљрЃљ
- рЃДрЃЋрЃћрЃџрЃљ DRAFT process stage-рЃќрЃћрЃљ
- Create dates: 10:33:36 - 10:36:08
- Modify dates: 11:53:13 - 11:54:39

рЃћрЃА рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћрЃЉрЃА, рЃарЃЮрЃЏ:
1. рЃДрЃЋрЃћрЃџрЃљ рЃћрЃА billing run рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃерЃћрЃўрЃЦрЃЏрЃюрЃљ (рЃЊрЃљрЃљрЃ«рЃџрЃЮрЃћрЃЉрЃўрЃЌ 2.5 рЃгрЃБрЃЌрЃўрЃА рЃњрЃљрЃюрЃЏрЃљрЃЋрЃџрЃЮрЃЉрЃљрЃерЃў)
2. рЃДрЃЋрЃћрЃџрЃљ рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃЊрЃљрЃЏрЃБрЃерЃљрЃЋрЃЊрЃљ
3. рЃДрЃЋрЃћрЃџрЃљ рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED-рЃерЃў (рЃЊрЃљрЃљрЃ«рЃџрЃЮрЃћрЃЉрЃўрЃЌ 1 рЃгрЃБрЃЌрЃўрЃА рЃњрЃљрЃюрЃЏрЃљрЃЋрЃџрЃЮрЃЉрЃљрЃерЃў)

## ­ЪћД рЃарЃћрЃЎрЃЮрЃЏрЃћрЃюрЃЊрЃљрЃфрЃўрЃћрЃЉрЃў CANCELLED-рЃЊрЃљрЃю COMPLETED-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃўрЃА рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃАрЃљрЃфрЃўрЃџрЃћрЃЉрЃџрЃљрЃЊ

### 1. Resume() рЃЏрЃћрЃЌрЃЮрЃЊрЃўрЃА рЃњрЃљрЃБрЃЏрЃ»рЃЮрЃЉрЃћрЃАрЃћрЃЉрЃљ

**рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃў рЃљрЃа рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА billing run-рЃўрЃА рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћ рЃАрЃбрЃљрЃбрЃБрЃАрЃА.

**рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃћрЃбрЃўрЃџрЃћрЃЉрЃљ:**
```java
@Transactional
public void resume(Long billingRunId, boolean mustCheckPermission) {
    BillingRun billingRun = billingRunRepository.findById(billingRunId)
        .orElseThrow(...);
    
    // Рџа№ИЈ рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ: рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЌ, рЃарЃЮрЃЏ billing run рЃљрЃа рЃљрЃарЃўрЃА CANCELLED
    if (billingRun.getStatus() == BillingStatus.CANCELLED) {
        throw new IllegalArgumentsProvidedException(
            "Cannot resume billing run with CANCELLED status. Billing run must be cancelled first or recreated."
        );
    }
    
    // Рџа№ИЈ рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ: рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЌ, рЃарЃЮрЃЏ billing run рЃљрЃа рЃљрЃарЃўрЃА DELETED
    if (billingRun.getStatus() == BillingStatus.DELETED) {
        throw new IllegalArgumentsProvidedException(
            "Cannot resume billing run with DELETED status."
        );
    }
    
    BillingRunProcessStage processStage = billingRun.getProcessStage();
    // ... existing code ...
}
```

### 2. Cancel() рЃЏрЃћрЃЌрЃЮрЃЊрЃўрЃА рЃњрЃљрЃБрЃЏрЃ»рЃЮрЃЉрЃћрЃАрЃћрЃЉрЃљ

**рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** `cancel()` рЃЏрЃћрЃЌрЃЮрЃЊрЃў рЃљрЃа рЃўрЃфрЃЋрЃџрЃўрЃА `processStage`-рЃА, рЃарЃљрЃф рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃгрЃЋрЃўрЃЮрЃА рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃћрЃЉрЃў resume-рЃўрЃА рЃЊрЃарЃЮрЃА.

**рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃћрЃбрЃўрЃџрЃћрЃЉрЃљ:**
```java
public void cancel(Long billingRunId, boolean mustCheckPermission) {
    // ... existing code ...
    
    billingRun.setStatus(BillingStatus.CANCELLED);
    // Рџа№ИЈ рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ: processStage-рЃўрЃА рЃњрЃљрЃБрЃЦрЃЏрЃћрЃЉрЃљ
    billingRun.setProcessStage(null);
    billingRunRepository.save(billingRun);
}
```

### 3. Scheduler-рЃўрЃА рЃњрЃљрЃБрЃЏрЃ»рЃЮрЃЉрЃћрЃАрЃћрЃЉрЃљ

**рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ:** Scheduler-рЃћрЃЉрЃў рЃљрЃа рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃћрЃю CANCELLED рЃАрЃбрЃљрЃбрЃБрЃАрЃА, рЃарЃЮрЃЊрЃћрЃАрЃљрЃф рЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃћрЃю billing run-рЃћрЃЉрЃА.

**рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃћрЃбрЃўрЃџрЃћрЃЉрЃљ:**
- `BillingRunStandardPreparationStateHandler`-рЃерЃў рЃЊрЃљрЃљрЃЏрЃљрЃбрЃћрЃЌ рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ, рЃарЃЮрЃЏ billing run рЃљрЃа рЃљрЃарЃўрЃА CANCELLED
- `BillingRunStartAccountingScheduler`-рЃерЃў рЃЊрЃљрЃљрЃЏрЃљрЃбрЃћрЃЌ рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ, рЃарЃЮрЃЏ billing run рЃљрЃа рЃљрЃарЃўрЃА CANCELLED

## ­ЪћД рЃарЃћрЃЎрЃЮрЃЏрЃћрЃюрЃЊрЃљрЃфрЃўрЃћрЃЉрЃў

### 1. Run Stage-рЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ

рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЌ, рЃарЃЮрЃЏрЃћрЃџ billing run-рЃћрЃЉрЃА рЃљрЃЦрЃЋрЃЌ `AUTOMATICALLY_ACCOUNTING` run stage:

```sql
SELECT 
    id,
    billing_number,
    status,
    run_stage,
    modify_date
FROM billing.billings
WHERE run_stage IS NOT NULL
AND modify_date >= CURRENT_DATE - INTERVAL '7 days'
ORDER BY modify_date DESC;
```

### 2. рЃџрЃЮрЃњрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ

рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЌ рЃљрЃърЃџрЃўрЃЎрЃљрЃфрЃўрЃўрЃА рЃџрЃЮрЃњрЃћрЃЉрЃў рЃерЃћрЃЏрЃЊрЃћрЃњрЃў рЃЌрЃљрЃарЃўрЃдрЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА:
- 2025-12-22 11:53:xx - 11:54:xx (19 billing run рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ)
- 2025-12-23 13:55:15 (ID 1647 - 14.78ms)

рЃЏрЃЮрЃФрЃћрЃЉрЃюрЃћрЃЌ:
- `"Billing run status changed to 'COMPLETED'"`
- `"AUTOMATICALLY_ACCOUNTING"`
- `"Starting billing run {} accounting"`

### 3. рЃЎрЃЮрЃЊрЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃў

**рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃБрЃарЃў рЃљрЃЊрЃњрЃўрЃџрЃћрЃЉрЃў:**

1. **BillingRunStartGenerationService.java:112** - рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃгрЃДрЃћрЃЉрЃА accounting-рЃА
2. **BillingRunStartAccountingService.java:113** - рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃфрЃЋрЃџрЃўрЃА COMPLETED-рЃќрЃћ
3. **BillingRunStandardPreparationStateScheduler.java:34** - scheduler рЃДрЃЮрЃЋрЃћрЃџ 15 рЃгрЃљрЃЏрЃерЃў

### 4. рЃерЃћрЃАрЃљрЃФрЃџрЃЮ рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃћрЃбрЃўрЃџрЃћрЃЉрЃћрЃЉрЃў

1. **Run Stage-рЃћрЃЉрЃўрЃА рЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃў:**
   - рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЌ, рЃарЃЮрЃЏрЃћрЃџ billing run-рЃћрЃЉрЃА рЃљрЃЦрЃЋрЃЌ `AUTOMATICALLY_ACCOUNTING`
   - рЃњрЃљрЃюрЃўрЃ«рЃўрЃџрЃћрЃЌ, рЃљрЃарЃўрЃА рЃЌрЃБ рЃљрЃарЃљ рЃћрЃА рЃАрЃгрЃЮрЃарЃў рЃЦрЃфрЃћрЃЋрЃљ

2. **Scheduler-рЃўрЃА рЃЮрЃърЃбрЃўрЃЏрЃўрЃќрЃљрЃфрЃўрЃљ:**
   - рЃњрЃљрЃюрЃўрЃ«рЃўрЃџрЃћрЃЌ scheduler-рЃўрЃА рЃАрЃўрЃ«рЃерЃўрЃарЃўрЃА рЃерЃћрЃЏрЃфрЃўрЃарЃћрЃЉрЃљ
   - рЃљрЃю billing run-рЃћрЃЉрЃўрЃА batch processing-рЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ

3. **рЃџрЃЮрЃњрЃўрЃарЃћрЃЉрЃўрЃА рЃњрЃљрЃБрЃЏрЃ»рЃЮрЃЉрЃћрЃАрЃћрЃЉрЃљ:**
   - рЃЊрЃљрЃљрЃЏрЃљрЃбрЃћрЃЌ рЃџрЃЮрЃњрЃћрЃЉрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃљрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃА, рЃарЃЮрЃЊрЃўрЃА рЃЊрЃљ рЃарЃљрЃбрЃЮрЃЏ рЃўрЃфрЃЋрЃџрЃћрЃЉрЃљ рЃАрЃбрЃљрЃбрЃБрЃАрЃў
   - рЃЊрЃљрЃљрЃЏрЃљрЃбрЃћрЃЌ рЃџрЃЮрЃњрЃћрЃЉрЃў run stage-рЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА

4. **рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃўрЃАрЃбрЃЮрЃарЃўрЃўрЃА рЃфрЃ«рЃарЃўрЃџрЃў:**
   - рЃњрЃљрЃюрЃўрЃ«рЃўрЃџрЃћрЃЌ `billing_status_change_hist` рЃфрЃ«рЃарЃўрЃџрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ (рЃЏрЃАрЃњрЃљрЃЋрЃАрЃў `account_period_status_change_hist`-рЃўрЃАрЃљ)
   - рЃћрЃА рЃЊрЃљрЃњрЃЋрЃћрЃ«рЃЏрЃљрЃарЃћрЃЉрЃљ рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃћрЃЉрЃўрЃА рЃўрЃАрЃбрЃЮрЃарЃўрЃўрЃА рЃЌрЃЋрЃљрЃџрЃДрЃБрЃарЃЊрЃћрЃЋрЃюрЃћрЃЉрЃљрЃерЃў
   - рЃћрЃА рЃњрЃљрЃюрЃАрЃљрЃЎрЃБрЃЌрЃарЃћрЃЉрЃўрЃЌ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃўрЃљ CANCELLED-рЃЊрЃљрЃю COMPLETED-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃўрЃА рЃЊрЃљрЃАрЃљрЃЊрЃњрЃћрЃюрЃљрЃЊ

5. **CANCELLED рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ:**
   - рЃДрЃЋрЃћрЃџрЃљ scheduler-рЃерЃў рЃЊрЃљрЃљрЃЏрЃљрЃбрЃћрЃЌ рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ, рЃарЃЮрЃЏ billing run рЃљрЃа рЃљрЃарЃўрЃА CANCELLED
   - `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃерЃў рЃЊрЃљрЃљрЃЏрЃљрЃбрЃћрЃЌ CANCELLED рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ
   - `cancel()` рЃЏрЃћрЃЌрЃЮрЃЊрЃерЃў рЃњрЃљрЃюрЃўрЃ«рЃўрЃџрЃћрЃЌ `processStage`-рЃўрЃА рЃњрЃљрЃБрЃЦрЃЏрЃћрЃЉрЃљ

## ­ЪЊї рЃЊрЃљрЃАрЃЎрЃЋрЃюрЃљ

Billing run-рЃћрЃЉрЃў рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃљ COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў рЃерЃћрЃЏрЃЊрЃћрЃњрЃў рЃЏрЃўрЃќрЃћрЃќрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮ:

### рЃФрЃўрЃарЃўрЃЌрЃљрЃЊрЃў рЃЏрЃўрЃќрЃћрЃќрЃћрЃЉрЃў:

1. **AUTOMATICALLY_ACCOUNTING Run Stage:** рЃарЃЮрЃЊрЃћрЃАрЃљрЃф billing run-рЃА рЃљрЃЦрЃЋрЃА рЃћрЃА run stage, рЃўрЃњрЃў рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃгрЃДрЃћрЃЉрЃА accounting рЃърЃарЃЮрЃфрЃћрЃАрЃА generation-рЃўрЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ.

2. **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃў рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃљ:** Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃўрЃА рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃАрЃбрЃљрЃбрЃБрЃАрЃў рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃфрЃЋрЃџрЃћрЃЉрЃљ COMPLETED-рЃќрЃћ.

3. **Scheduler-рЃўрЃА рЃњрЃљрЃЋрЃџрЃћрЃюрЃљ:** Scheduler рЃДрЃЮрЃЋрЃћрЃџ 15 рЃгрЃљрЃЏрЃерЃў рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА рЃЊрЃљ рЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃА billing run-рЃћрЃЉрЃА, рЃарЃљрЃф рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃгрЃЋрЃўрЃЮрЃА рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ billing run-рЃўрЃА рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃЊрЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃљ.

4. **Thread-based Processing:** Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћрЃЮрЃЉрЃА рЃљрЃ«рЃљрЃџ Thread-рЃерЃў, рЃарЃљрЃф рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃгрЃЋрЃўрЃЮрЃА рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ billing run-рЃўрЃА рЃћрЃарЃЌрЃЊрЃарЃЮрЃБрЃџрЃљрЃЊ рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃљ.

5. **Resume() + BillingRunStartAccountingScheduler (AUTOMATICALLY_ACCOUNTING-рЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ):** 
   - `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃў, рЃЌрЃБ `processStage` рЃљрЃарЃўрЃА ACCOUNTING, рЃљрЃДрЃћрЃюрЃћрЃЉрЃА рЃАрЃбрЃљрЃбрЃБрЃАрЃА IN_PROGRESS_ACCOUNTING-рЃќрЃћ
   - `BillingRunStartAccountingScheduler` (PostConstruct-рЃерЃў) рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА IN_PROGRESS_ACCOUNTING рЃАрЃбрЃљрЃбрЃБрЃАрЃўрЃА billing run-рЃћрЃЉрЃА
   - Scheduler **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃўрЃгрЃДрЃћрЃЉрЃА accounting рЃърЃарЃЮрЃфрЃћрЃАрЃА `isResumeProcess = true`-рЃўрЃЌ
   - Accounting рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃћрЃЉрЃљ рЃЊрЃљ billing run **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ** рЃњрЃљрЃЊрЃљрЃЊрЃўрЃА COMPLETED-рЃќрЃћ
   - **рЃћрЃА рЃ«рЃЊрЃћрЃЉрЃљ AUTOMATICALLY_ACCOUNTING run stage-рЃўрЃА рЃњрЃљрЃарЃћрЃерЃћ!**

### CANCELLED-рЃЊрЃљрЃю COMPLETED-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃўрЃА рЃЏрЃўрЃќрЃћрЃќрЃў:

6. **Resume() рЃЏрЃћрЃЌрЃЮрЃЊрЃўрЃА рЃюрЃљрЃЎрЃџрЃў:** `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃў рЃљрЃа рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА billing run-рЃўрЃА рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћ рЃАрЃбрЃљрЃбрЃБрЃАрЃА (CANCELLED, DELETED). рЃўрЃА рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ `processStage`-рЃА рЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃА, рЃарЃљрЃф рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃгрЃЋрЃўрЃЮрЃА CANCELLED billing run-рЃўрЃА resume-рЃЊрЃљ рЃЊрЃљ рЃерЃћрЃЏрЃЊрЃћрЃњ COMPLETED-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃљ.

**рЃЊрЃљрЃАрЃЎрЃЋрЃюрЃљ:** Billing run-рЃћрЃЉрЃў рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃњрЃљрЃЊрЃљрЃЋрЃўрЃЊрЃюрЃћрЃю COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў **рЃЮрЃарЃў рЃњрЃќрЃўрЃЌ:**
1. **AUTOMATICALLY_ACCOUNTING run stage-рЃўрЃЌ** - generation-рЃўрЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃгрЃДрЃћрЃЉрЃА accounting-рЃА
2. **Resume() + BillingRunStartAccountingScheduler-рЃўрЃЌ** - рЃЌрЃБ `processStage` рЃљрЃарЃўрЃА ACCOUNTING, resume() рЃљрЃДрЃћрЃюрЃћрЃЉрЃА IN_PROGRESS_ACCOUNTING-рЃќрЃћ, рЃЊрЃљ scheduler рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃўрЃгрЃДрЃћрЃЉрЃА accounting-рЃА

**CANCELLED-рЃЊрЃљрЃю COMPLETED-рЃќрЃћ рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃљ рЃљрЃа рЃљрЃарЃўрЃА рЃЏрЃЮрЃАрЃљрЃџрЃЮрЃЊрЃюрЃћрЃџрЃў рЃЦрЃфрЃћрЃЋрЃљ** рЃЊрЃљ рЃАрЃљрЃГрЃўрЃарЃЮрЃћрЃЉрЃА рЃњрЃљрЃАрЃгрЃЮрЃарЃћрЃЉрЃљрЃА `resume()` рЃЏрЃћрЃЌрЃЮрЃЊрЃерЃў.

---

**рЃљрЃюрЃњрЃљрЃарЃўрЃерЃў рЃњрЃћрЃюрЃћрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃўрЃљ:** 2025-12-25  
**рЃЉрЃљрЃќрЃљ:** phoenix (Test Environment - 10.236.20.24:5432)  
**рЃљрЃюрЃљрЃџрЃўрЃќрЃў:** Billing run-рЃћрЃЉрЃўрЃА рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃў COMPLETED рЃАрЃбрЃљрЃбрЃБрЃАрЃерЃў рЃњрЃљрЃЊрЃљрЃАрЃЋрЃџрЃўрЃА рЃЏрЃўрЃќрЃћрЃќрЃћрЃЉрЃўрЃА рЃўрЃЊрЃћрЃюрЃбрЃўрЃцрЃўрЃфрЃўрЃарЃћрЃЉрЃљ

